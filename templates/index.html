<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>YTDownloadX - Free YouTube Video & Playlist Downloader</title>
  <link rel="icon" href="{{ url_for('static', filename='image/YTDownloadX.png') }}?v=3" type="image/x-icon">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='styles.css') }}?v=5" rel="stylesheet">
</head>

<body class="bg-dark" data-bs-theme="dark">
  <nav class="navbar navbar-expand-lg navbar-dark bg-black border-bottom border-secondary">
    <div class="container">
      <a class="navbar-brand fw-bold fs-4" href="/">
        <span class="text-primary">YT</span><span class="text-white">DownloadX</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav"
        aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="nav">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link text-white-50 hover-text-white" href="/">Home</a></li>
          <li class="nav-item"><a class="nav-link text-white-50 hover-text-white" href="/about">About</a></li>
          <li class="nav-item"><a class="nav-link text-white-50 hover-text-white" href="#features">Features</a></li>
          <li class="nav-item"><a class="nav-link text-white-50 hover-text-white" href="#download">Download</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <section class="hero-section">
    <div class="hero-background">
      <div class="geometric-shape shape-1"></div>
      <div class="geometric-shape shape-2"></div>
      <div class="geometric-shape shape-3"></div>
      <div class="geometric-shape shape-4"></div>
      <div class="geometric-shape shape-5"></div>
    </div>

    <div class="container">
      <div class="row justify-content-center text-center">
        <div class="col-lg-8">
          <div class="hero-badge">
            <span class="badge-dot"></span>
            <span>Free YouTube Downloader</span>
          </div>

          <h1 class="hero-title">
            <span class="hero-title-main">Download YouTube Videos</span>
            <br>
            <span class="hero-title-gradient">Fast &amp; High Quality</span>
          </h1>

          <p class="hero-description">
            Download YouTube videos and playlists in HD quality with our fast,
            free downloader. Support for MP4, MP3, and all popular formats.
          </p>

          <div class="hero-cta">
            <a href="#download" class="btn btn-primary btn-lg px-4 py-3 me-3">
              Start Downloading
            </a>
            <a href="#features" class="btn btn-outline-light btn-lg px-4 py-3">
              Learn More
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <main class="container py-5" id="download">

    <!-- URL + buttons -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="row g-2 align-items-center">
          <div class="col-12 col-lg-8">
            <input id="url" type="url" class="form-control form-control-lg"
              placeholder="https://www.youtube.com/watch?v=... or playlist URL">
          </div>
          <div class="col-12 col-lg-4 d-grid d-lg-block">
            <button id="fetchBtn" class="btn btn-primary btn-lg w-100">
              <span class="fetch-text">Fetch Details</span>
              <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            </button>
          </div>
          <div class="col-12 mt-2 text-center">
            <button id="resetBtn" class="btn btn-outline-secondary btn-sm">Reset All Fields</button>
            <button id="notifySettingsBtn" class="btn btn-outline-info btn-sm ms-2" title="Notification Settings">
              ðŸ”” Notifications
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Metadata section (video OR playlist) -->
    <div id="metaSection" class="d-none">
      <!-- Single video -->
      <div id="videoMeta" class="row g-3 align-items-center mb-3 d-none">
        <div class="col-12 col-md-3 text-center">
          <img id="thumb" class="img-fluid rounded" alt="thumbnail">
        </div>
        <div class="col-12 col-md-9">
          <h5 id="title" class="mb-1"></h5>
          <div class="text-secondary small mb-2">
            <span id="channel"></span>
            <span id="duration" class="ms-2"></span>
          </div>
          <div class="row g-2">
            <div class="col-6 col-md-3">
              <label class="form-label small">Format</label>
              <select id="format" class="form-select">
                <option value="mp4">MP4 (video)</option>
                <option value="mp3">MP3 (audio)</option>
              </select>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small">Resolution</label>
              <select id="resolution" class="form-select"></select>
            </div>
            <div class="col-12 col-md-6 d-grid d-md-block">
              <button id="downloadBtn" class="btn btn-success w-100">Start Download</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Playlist -->
      <div id="playlistMeta" class="mb-3 d-none">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-2">
          <div>
            <h5 class="mb-1" id="plTitle">Playlist Videos</h5>
            <small class="text-secondary" id="plSub"></small>
          </div>
          <div class="mt-2 mt-md-0">
            <label class="me-2"><input id="selectAll" type="checkbox"> Select All</label>
            <select id="plFormat" class="form-select d-inline-block w-auto">
              <option value="mp4">MP4 (video)</option>
              <option value="mp3">MP3 (audio)</option>
            </select>
            <select id="plResolution" class="form-select d-inline-block w-auto"></select>
            <button id="plDownloadBtn" class="btn btn-success ms-2">Download Selected</button>
          </div>
        </div>
        <div id="playlistList" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3"></div>
      </div>
    </div>

    <!-- Progress area -->
    <div id="progressArea" class="d-none mt-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div><strong id="currentFile">Preparing...</strong></div>
            <div id="eta" class="text-secondary small"></div>
          </div>
          <div id="playlistProgress" class="mb-2 d-none">
            <small class="text-secondary">
              Processing video <span id="currentVideo">1</span> of
              <span id="totalVideos">1</span>
            </small>
          </div>
          <div class="progress" role="progressbar" aria-label="Download progress" aria-valuemin="0"
            aria-valuemax="100">
            <div id="progressBar" class="progress-bar" style="width: 0%">0%</div>
          </div>
          <div id="doneArea" class="mt-3 d-none">
            <span id="doneHint" class="text-secondary small"></span>
          </div>
          <div id="qrWrap" class="text-center mt-3 d-none">
            <p class="text-secondary small mb-1">Scan to open this file on your phone (valid ~30 minutes)</p>
            <img id="qr" class="border rounded p-1" alt="QR" />
          </div>
        </div>
      </div>
    </div>

    <!-- Features Section -->
    <section id="features" class="py-5 mt-5">
      <div class="container">
        <div class="row justify-content-center mb-5">
          <div class="col-lg-8 text-center">
            <h2 class="fw-bold mb-3">Powerful Features</h2>
            <p class="text-muted">Everything you need for downloading YouTube content</p>
          </div>
        </div>

        <div class="row g-4">
          <div class="col-lg-4">
            <div class="feature-card">
              <div class="feature-icon">
                <span class="star">â˜…</span>
              </div>
              <h4 class="fw-bold mb-3">Playlist &amp; Bulk Downloads</h4>
              <p class="text-muted">
                Download an entire playlist or multiple videos in one go â€” no need to copy each link separately.
              </p>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="feature-card">
              <div class="feature-icon">
                <span class="star">â˜…</span>
              </div>
              <h4 class="fw-bold mb-3">QR Code Link Sharing</h4>
              <p class="text-muted">
                Generate a QR code for any download link directly inside the app. Scan on your phone and start the
                download instantly.
              </p>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="feature-card">
              <div class="feature-icon">
                <span class="star">â˜…</span>
              </div>
              <h4 class="fw-bold mb-3">Fast, High-Quality Downloads</h4>
              <p class="text-muted">
                Choose between MP4 and MP3, pick your resolution, and download without ads or interruptions.
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-black text-white py-4 border-top border-secondary">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="d-flex align-items-center">
            <span class="navbar-brand fw-bold fs-5 mb-0 me-4">
              <span class="text-primary">YT</span><span class="text-white">DownloadX</span>
            </span>
            <div class="d-flex gap-3">
              <a href="#" class="text-white-50 text-decoration-none hover-text-white">Privacy</a>
              <a href="#" class="text-white-50 text-decoration-none hover-text-white">Terms</a>
              <a href="#" class="text-white-50 text-decoration-none hover-text-white">Contact</a>
            </div>
          </div>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
          <small class="text-white-50">
            &copy; <span id="year"></span> YTDownloadX. Free YouTube downloader.
          </small>
        </div>
      </div>
    </div>
  </footer>

  <!-- Particle Network Background -->
  <script src="{{ url_for('static', filename='particles.js') }}?v=4"></script>

  <!-- Glare Hover Effect -->
  <script src="{{ url_for('static', filename='glare-hover.js') }}?v=1"></script>

  <script>
    const d = (sel) => document.querySelector(sel);
    const dd = (sel) => document.querySelectorAll(sel);

    const secondsToHms = s => {
      if (!s && s !== 0) return "";
      const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = s % 60;
      return [h ? `${h}h` : null, m ? `${m}m` : null, `${sec}s`].filter(Boolean).join(' ');
    };

    document.getElementById('year').textContent = new Date().getFullYear();

    // ============================================
    // NOTIFICATION SYSTEM
    // ============================================
    const notifyPrefs = {
      enabled: localStorage.getItem('notifyEnabled') !== 'false',
      sound: localStorage.getItem('notifySound') !== 'false'
    };

    if ('Notification' in window && notifyPrefs.enabled) {
      if (Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    const playNotificationSound = () => {
      if (!notifyPrefs.sound) return;
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.connect(gain);
      gain.connect(audioContext.destination);
      osc.frequency.value = 800;
      osc.type = 'sine';
      gain.gain.setValueAtTime(0.3, audioContext.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
      osc.start(audioContext.currentTime);
      osc.stop(audioContext.currentTime + 0.5);
    };

    const showDownloadNotification = (title) => {
      if (!notifyPrefs.enabled) return;
      playNotificationSound();
      if ('Notification' in window && Notification.permission === 'granted') {
        const n = new Notification('Download Complete ðŸŽ‰', {
          body: title || 'Your file has finished downloading.',
          icon: '/static/image/YTDownloadX.png',
          badge: '/static/image/YTDownloadX.png',
          tag: 'download-complete',
        });
        n.onclick = () => {
          window.focus();
          n.close();
        };
        setTimeout(() => n.close(), 5000);
      }
    };

    window.saveNotifyPrefs = (enabled, sound) => {
      notifyPrefs.enabled = enabled;
      notifyPrefs.sound = sound;
      localStorage.setItem('notifyEnabled', enabled);
      localStorage.setItem('notifySound', sound);
    };

    // =====================================================
    // FORMAT HELPERS
    // =====================================================
    const populateResolutionSelect = (selectEl, formats, isAudio = false) => {
      selectEl.innerHTML = '';
      const bestOpt = document.createElement('option');
      bestOpt.value = 'best';
      bestOpt.textContent = isAudio ? 'Best audio quality' : 'Best video quality';
      selectEl.appendChild(bestOpt);

      if (!formats || !formats.length) return;

      const filtered = formats.filter(f => {
        if (isAudio) {
          return f.acodec && f.acodec !== 'none' && (!f.vcodec || f.vcodec === 'none');
        } else {
          return f.vcodec && f.vcodec !== 'none';
        }
      });

      filtered.sort((a, b) => (b.height || 0) - (a.height || 0));

      filtered.forEach(f => {
        const opt = document.createElement('option');
        opt.value = f.format_id;
        if (isAudio) {
          const kbps = f.tbr ? `${Math.round(f.tbr)}kbps` : '';
          opt.textContent = `Audio ${f.ext?.toUpperCase() || ''} ${kbps}`.trim();
        } else {
          const res = f.resolution || (f.height ? `${f.height}p` : '');
          const fps = f.fps ? `${f.fps}fps` : '';
          opt.textContent = `${res} ${f.ext?.toUpperCase() || ''} ${fps}`.trim();
        }
        selectEl.appendChild(opt);
      });
    };

    const setVideoMeta = (video) => {
      d('#videoMeta').classList.remove('d-none');
      d('#playlistMeta').classList.add('d-none');

      d('#thumb').src = video.thumbnail || '/static/image/YTDownloadX.png';
      d('#title').textContent = video.title || 'Unknown title';
      d('#channel').textContent = video.uploader ? `By ${video.uploader}` : '';
      d('#duration').textContent = video.duration ? `â€¢ ${secondsToHms(video.duration)}` : '';

      populateResolutionSelect(d('#resolution'), video.formats, false);
    };

    const setPlaylistMeta = (playlist, formats) => {
      d('#videoMeta').classList.add('d-none');
      d('#playlistMeta').classList.remove('d-none');

      d('#plTitle').textContent = playlist.title || 'Playlist';
      d('#plSub').textContent = `${playlist.video_count || playlist.videos.length} videos â€¢ ${playlist.uploader || ''}`;

      const list = d('#playlistList');
      list.innerHTML = '';

      playlist.videos.forEach(v => {
        const col = document.createElement('div');
        col.className = 'col';
        col.innerHTML = `
          <div class="card h-100 playlist-item-card">
            <div class="row g-0 h-100">
              <div class="col-4">
                <img src="${v.thumbnail || '/static/image/YTDownloadX.png'}" class="img-fluid rounded-start h-100 w-100 object-fit-cover" alt="thumb">
              </div>
              <div class="col-8">
                <div class="card-body d-flex flex-column">
                  <h6 class="card-title mb-1 text-truncate" title="${v.title || ''}">${v.title || ''}</h6>
                  <small class="text-secondary mb-1">${v.uploader || ''}</small>
                  <small class="text-secondary mb-2">${secondsToHms(v.duration) || ''}</small>
                  <div class="mt-auto form-check">
                    <input class="form-check-input sel" type="checkbox"
                      data-url="${v.url}" data-title="${v.title || ''}">
                    <label class="form-check-label small">Select</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        list.appendChild(col);
      });

      populateResolutionSelect(d('#plResolution'), formats || [], false);
    };

    // =====================================================
    // PROGRESS + DOWNLOAD
    // =====================================================
    const setProgress = (pct, label) => {
      const area = d('#progressArea');
      const bar = d('#progressBar');
      area.classList.remove('d-none');
      bar.style.width = `${pct}%`;
      bar.textContent = `${pct}%`;
      if (label) d('#currentFile').textContent = label;
    };

    const resetProgress = () => {
      d('#progressBar').className = 'progress-bar';
      setProgress(0, 'Preparing download...');
      d('#doneArea').classList.add('d-none');
      d('#qrWrap').classList.add('d-none');
      d('#playlistProgress').classList.add('d-none');
      d('#eta').textContent = '';
    };

    const startDownloadWithUI = async ({ url, kind, format_id, title, index, total }) => {
      if (!url) return;

      const btn = kind === 'playlist'
        ? d('#plDownloadBtn')
        : d('#downloadBtn');

      const labelTitle = title || 'Downloading...';

      resetProgress();
      d('#progressArea').classList.remove('d-none');
      d('#currentFile').textContent = labelTitle;

      if (total && total > 1) {
        d('#playlistProgress').classList.remove('d-none');
        d('#totalVideos').textContent = total;
        d('#currentVideo').textContent = index;
      }

      // auto-scroll so user sees progress
      d('#progressArea').scrollIntoView({ behavior: 'smooth', block: 'center' });

      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Starting download...';

      try {
        setProgress(5, 'Contacting server...');
        const res = await fetch('/api/download', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            url,
            kind: kind === 'mp3' ? 'mp3' : 'mp4',
            format_id: format_id || 'best',
          }),
        });

        if (!res.ok) {
          let errMsg = `Download failed with status ${res.status}`;
          try {
            const errData = await res.json();
            if (errData && errData.message) errMsg = errData.message;
          } catch (e) { /* ignore */ }
          throw new Error(errMsg);
        }

        setProgress(35, 'Downloading...');
        const downloadId = res.headers.get('X-Download-Id') || '';
        const contentDisp = res.headers.get('Content-Disposition') || '';
        let filename = 'download';

        const m = contentDisp.match(/filename="?([^"]+)"?/i);
        if (m && m[1]) filename = m[1];

        const blob = await res.blob();
        setProgress(70, 'Finishing...');

        const blobUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(blobUrl);

        setProgress(100, 'Download completed!');
        d('#progressBar').classList.add('bg-success');
        d('#doneArea').classList.remove('d-none');
        d('#doneHint').textContent = `Saved as: ${filename}`;

        // QR for mobile
        if (downloadId) {
          const fileUrl = `${window.location.origin}/files/${downloadId}`;
          d('#qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(fileUrl)}`;
          d('#qrWrap').classList.remove('d-none');
        }

        showDownloadNotification(filename);
      } catch (err) {
        console.error('Download error:', err);
        d('#progressBar').classList.add('bg-danger');
        d('#currentFile').textContent = `Download failed: ${err.message}`;
        alert(`Download failed: ${err.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    };

    // =====================================================
    // EVENT HANDLERS
    // =====================================================

    // Reset button
    d('#resetBtn').addEventListener('click', () => {
      d('#url').value = '';
      d('#metaSection').classList.add('d-none');
      d('#videoMeta').classList.add('d-none');
      d('#playlistMeta').classList.add('d-none');
      d('#progressArea').classList.add('d-none');
      d('#doneArea').classList.add('d-none');
      d('#qrWrap').classList.add('d-none');
      d('#playlistList').innerHTML = '';
      d('#plSub').textContent = '';
      d('#plTitle').textContent = 'Playlist Videos';
      resetProgress();
    });

    // Metadata fetch
    d('#fetchBtn').addEventListener('click', async () => {
      const url = d('#url').value.trim();
      if (!url) {
        alert('Please enter a YouTube URL');
        return;
      }
      if (!url.includes('youtube.com') && !url.includes('youtu.be')) {
        alert('Please enter a valid YouTube URL');
        return;
      }

      const btn = d('#fetchBtn');
      btn.disabled = true;
      btn.querySelector('.fetch-text').classList.add('d-none');
      btn.querySelector('.spinner-border').classList.remove('d-none');

      try {
        const res = await fetch('/api/metadata', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        const data = await res.json();

        if (!res.ok || data.error) {
          throw new Error(data.message || data.error || 'Failed to fetch info');
        }

        d('#metaSection').classList.remove('d-none');

        if (data.kind === 'playlist') {
          setPlaylistMeta(data.playlist, data.formats || []);
        } else {
          setVideoMeta(data.video);
        }
      } catch (err) {
        console.error('Metadata error:', err);
        alert(`Error: ${err.message}\n\nPlease check that the URL is correct and try again.`);
      } finally {
        btn.disabled = false;
        btn.querySelector('.fetch-text').classList.remove('d-none');
        btn.querySelector('.spinner-border').classList.add('d-none');
      }
    });

    // Select all in playlist
    d('#selectAll').addEventListener('change', (e) => {
      dd('.sel').forEach(cb => cb.checked = e.target.checked);
    });

    // Single video download
    d('#downloadBtn').addEventListener('click', async () => {
      const url = d('#url').value.trim();
      if (!url) {
        alert('Please enter a URL first');
        return;
      }
      const kind = d('#format').value;
      const formatId = d('#resolution').value || 'best';
      const title = d('#title').textContent || 'Video';

      await startDownloadWithUI({
        url,
        kind,
        format_id: formatId,
        title,
        index: 1,
        total: 1,
      });
    });

    // Playlist download (selected)
    d('#plDownloadBtn').addEventListener('click', async () => {
      const url = d('#url').value.trim();
      if (!url) {
        alert('Please enter a URL first');
        return;
      }
      const selected = Array.from(dd('.sel')).filter(cb => cb.checked);
      if (selected.length === 0) {
        alert('Select at least one video from the playlist');
        return;
      }

      const kindSel = d('#plFormat').value;
      const resSel = d('#plResolution').value || 'best';

      for (let i = 0; i < selected.length; i++) {
        const cb = selected[i];
        const vidUrl = cb.dataset.url;
        const title = cb.dataset.title || `Video ${i + 1}`;
        await startDownloadWithUI({
          url: vidUrl,
          kind: kindSel,
          format_id: resSel,
          title,
          index: i + 1,
          total: selected.length,
        });
      }
    });

    // (Optional) you could attach a click handler to #notifySettingsBtn
    // to open some small modal or just toggle prefs. For now it just toggles.
    d('#notifySettingsBtn').addEventListener('click', () => {
      const newEnabled = !notifyPrefs.enabled;
      saveNotifyPrefs(newEnabled, notifyPrefs.sound);
      alert(`Desktop notifications are now ${newEnabled ? 'enabled' : 'disabled'}.`);
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
