<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>YTDownloadX - Free YouTube Video & Playlist Downloader</title>
  <link rel="icon" href="{{ url_for('static', filename='image/YTDownloadX.png') }}?v=2" type="image/x-icon">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/styles.css?v=4" rel="stylesheet">
</head>

<body class="bg-dark" data-bs-theme="dark">
  <nav class="navbar navbar-expand-lg navbar-dark bg-black border-bottom border-secondary">
    <div class="container">
      <a class="navbar-brand fw-bold fs-4" href="/">
        <span class="text-primary">YT</span><span class="text-white">DownloadX</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav"
        aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="nav">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link text-white-50 hover-text-white" href="/">Home</a></li>
          <li class="nav-item"><a class="nav-link text-white-50 hover-text-white" href="/about">About</a></li>
          <li class="nav-item"><a class="nav-link text-white-50 hover-text-white" href="#features">Features</a></li>
          <li class="nav-item"><a class="nav-link text-white-50 hover-text-white" href="#download">Download</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <section class="hero-section">
    <div class="hero-background">
      <div class="geometric-shape shape-1"></div>
      <div class="geometric-shape shape-2"></div>
      <div class="geometric-shape shape-3"></div>
      <div class="geometric-shape shape-4"></div>
      <div class="geometric-shape shape-5"></div>
    </div>

    <div class="container">
      <div class="row justify-content-center text-center">
        <div class="col-lg-8">
          <div class="hero-badge">
            <span class="badge-dot"></span>
            <span>Free YouTube Downloader</span>
          </div>

          <h1 class="hero-title">
            <span class="hero-title-main">Download YouTube Videos</span>
            <br>
            <span class="hero-title-gradient">Fast & High Quality</span>
          </h1>

          <p class="hero-description">
            Download YouTube videos and playlists in HD quality with our fast,
            free downloader. Support for MP4, MP3, and all popular formats.
          </p>

          <div class="hero-cta">
            <a href="#download" class="btn btn-primary btn-lg px-4 py-3 me-3">
              Start Downloading
            </a>
            <a href="#features" class="btn btn-outline-light btn-lg px-4 py-3">
              Learn More
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <main class="container py-5" id="download">

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="row g-2 align-items-center">
          <div class="col-12 col-lg-8">
            <input id="url" type="url" class="form-control form-control-lg"
              placeholder="https://www.youtube.com/watch?v=... or playlist URL">
          </div>
          <div class="col-12 col-lg-4 d-grid d-lg-block">
            <button id="fetchBtn" class="btn btn-primary btn-lg w-100">
              <span class="fetch-text">Fetch Details</span>
              <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            </button>
          </div>
          <div class="col-12 mt-2 text-center">
            <button id="resetBtn" class="btn btn-outline-secondary btn-sm">Reset All Fields</button>
            <button id="notifySettingsBtn" class="btn btn-outline-info btn-sm ms-2" title="Notification Settings">
              üîî Notifications
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="metaSection" class="d-none">
      <div id="videoMeta" class="row g-3 align-items-center mb-3 d-none">
        <div class="col-12 col-md-3 text-center">
          <img id="thumb" class="img-fluid rounded" alt="thumbnail">
        </div>
        <div class="col-12 col-md-9">
          <h5 id="title" class="mb-1"></h5>
          <div class="text-secondary small mb-2"><span id="channel"></span> <span id="duration" class="ms-2"></span>
          </div>
          <div class="row g-2">
            <div class="col-6 col-md-3">
              <label class="form-label small">Format</label>
              <select id="format" class="form-select">
                <option value="mp4">MP4 (video)</option>
                <option value="mp3">MP3 (audio)</option>
              </select>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small">Resolution</label>
              <select id="resolution" class="form-select"></select>
            </div>
            <div class="col-12 col-md-6 d-grid d-md-block">
              <button id="downloadBtn" class="btn btn-success w-100">Start Download</button>
            </div>
          </div>
        </div>
      </div>

      <div id="playlistMeta" class="mb-3 d-none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Playlist Videos</h5>
          <div>
            <label class="me-2"><input id="selectAll" type="checkbox"> Select All</label>
            <select id="plFormat" class="form-select d-inline-block w-auto">
              <option value="mp4">MP4 (video)</option>
              <option value="mp3">MP3 (audio)</option>
            </select>
            <select id="plResolution" class="form-select d-inline-block w-auto"></select>
            <button id="plDownloadBtn" class="btn btn-success ms-2">Download Selected</button>
          </div>
        </div>
        <div id="playlistList" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3"></div>
      </div>
    </div>

    <div id="progressArea" class="d-none">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div><strong id="currentFile">Preparing...</strong></div>
            <div id="eta" class="text-secondary small"></div>
          </div>
          <div id="playlistProgress" class="mb-2 d-none">
            <small class="text-secondary">Processing video <span id="currentVideo">1</span> of <span
                id="totalVideos">1</span></small>
          </div>
          <div id="itemsProgress" class="mb-3 d-none"></div>
          <div class="progress" role="progressbar" aria-label="Download progress" aria-valuemin="0" aria-valuemax="100">
            <div id="progressBar" class="progress-bar" style="width: 0%">0%</div>
          </div>
          <div id="doneArea" class="mt-3 d-none">
            <a id="downloadLink" class="btn btn-primary" href="#" download>Download file</a>
            <span id="doneHint" class="text-secondary small ms-2"></span>
          </div>
          <div id="qrWrap" class="text-center mt-3 d-none">
            <p class="text-secondary small mb-1">Scan to open on mobile</p>
            <img id="qr" class="border rounded p-1" alt="QR" />
          </div>
        </div>
      </div>
    </div>

    <!-- Features Section -->
    <section id="features" class="py-5 mt-5">
      <div class="container">
        <div class="row justify-content-center mb-5">
          <div class="col-lg-8 text-center">
            <h2 class="fw-bold mb-3">Powerful Features</h2>
            <p class="text-muted">Everything you need for downloading YouTube content</p>
          </div>
        </div>

        <div class="row g-4">
          <div class="col-lg-4">
            <div class="feature-card">
              <div class="feature-icon">
                <span class="star">‚≠ê</span>
              </div>
              <h4 class="fw-bold mb-3">Playlist & Bulk Downloads</h4>
              <p class="text-muted">
                Download an entire playlist or multiple videos in one go ‚Äî no need to copy each link separately.
                This is a big time-saver and something most simple downloaders don't do well.
              </p>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="feature-card">
              <div class="feature-icon">
                <span class="star">‚≠ê</span>
              </div>
              <h4 class="fw-bold mb-3">QR Code Link Sharing</h4>
              <p class="text-muted">
                Generate a QR code for any download link directly inside the app. Users can scan the code on their phone
                and start the download instantly ‚Äî super convenient for moving videos between devices.
              </p>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="feature-card">
              <div class="feature-icon">
                <span class="star">‚≠ê</span>
              </div>
              <h4 class="fw-bold mb-3">Fast, High-Quality Downloads</h4>
              <p class="text-muted">
                Your app automatically fetches video details (title, thumbnail, etc.) and lets users pick formats
                (MP4, MP3, HD, etc.) for fast, high-quality downloads without ads or interruptions.
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-black text-white py-4 border-top border-secondary">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="d-flex align-items-center">
            <span class="navbar-brand fw-bold fs-5 mb-0 me-4">
              <span class="text-primary">YT</span><span class="text-white">DownloadX</span>
            </span>
            <div class="d-flex gap-3">
              <a href="#" class="text-white-50 text-decoration-none hover-text-white">Privacy</a>
              <a href="#" class="text-white-50 text-decoration-none hover-text-white">Terms</a>
              <a href="#" class="text-white-50 text-decoration-none hover-text-white">Contact</a>
            </div>
          </div>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
          <small class="text-white-50">
            &copy; <span id="year"></span> YTDownloadX. Free YouTube downloader.
          </small>
        </div>
      </div>
    </div>
  </footer>

  <!-- Particle Network Background -->
  <script src="/static/particles.js?v=4"></script>

  <!-- Glare Hover Effect -->
  <script src="/static/glare-hover.js?v=1"></script>

  <script>
    const d = (sel) => document.querySelector(sel);
    const dd = (sel) => document.querySelectorAll(sel);
    const secondsToHms = s => {
      if (!s && s !== 0) return "";
      const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = s % 60;
      return [h ? `${h}h` : null, m ? `${m}m` : null, `${sec}s`].filter(Boolean).join(' ');
    }

    document.getElementById('year').textContent = new Date().getFullYear();

    // ============================================
    // NOTIFICATION SYSTEM
    // ============================================

    // Load notification preferences from localStorage
    const notifyPrefs = {
      enabled: localStorage.getItem('notifyEnabled') !== 'false', // default true
      sound: localStorage.getItem('notifySound') !== 'false' // default true
    };

    // Request notification permission on page load
    if ('Notification' in window && notifyPrefs.enabled) {
      if (Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    // Sound alert (simple beep)
    const playNotificationSound = () => {
      if (!notifyPrefs.sound) return;

      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.frequency.value = 800; // Hz
      oscillator.type = 'sine';

      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.5);
    };

    // Show download complete notification
    const showDownloadNotification = (videoTitle) => {
      if (!notifyPrefs.enabled) return;

      // Play sound first
      playNotificationSound();

      // Show browser notification
      if ('Notification' in window && Notification.permission === 'granted') {
        const notification = new Notification('Download Complete! üéâ', {
          body: videoTitle || 'Your video has finished downloading.',
          icon: '/static/image/YTDownloadX.png',
          badge: '/static/image/YTDownloadX.png',
          tag: 'download-complete',
          requireInteraction: false
        });

        // Focus window when notification is clicked
        notification.onclick = () => {
          window.focus();
          notification.close();
        };

        // Auto-close after 5 seconds
        setTimeout(() => notification.close(), 5000);
      }
    };

    // Save notification preferences
    window.saveNotifyPrefs = (enabled, sound) => {
      notifyPrefs.enabled = enabled;
      notifyPrefs.sound = sound;
      localStorage.setItem('notifyEnabled', enabled);
      localStorage.setItem('notifySound', sound);
    };

    // ============================================
    // END NOTIFICATION SYSTEM
    // ============================================

    // Reset button functionality
    d('#resetBtn').addEventListener('click', () => {
      d('#url').value = '';
      d('#metaSection').classList.add('d-none');
      d('#progressArea').classList.add('d-none');
      d('#videoMeta').classList.add('d-none');
      d('#playlistMeta').classList.add('d-none');
      d('#doneArea').classList.add('d-none');
      d('#qrWrap').classList.add('d-none');
      d('#progressBar').style.width = '0%';
      d('#progressBar').textContent = '0%';
      d('#progressBar').className = 'progress-bar';
    });

    // Theme is fixed to dark mode

    // Optimized resolution options - only useful values
    const getOptimizedResolutions = (availableResolutions) => {
      const preferredResolutions = ['4320p', '2160p', '1440p', '1080p', '720p', '480p', '360p', '240p', '144p'];
      const available = availableResolutions || [];

      // Filter to only include resolutions that are both preferred and available
      const filtered = preferredResolutions.filter(res =>
        available.some(avail => avail.includes(res.replace('p', '')))
      );

      // If no matches, fall back to original available resolutions, but filter out very small ones
      if (filtered.length === 0) {
        return available.filter(res => {
          const height = parseInt(res);
          return height >= 144; // Only include 144p and above
        });
      }

      return filtered;
    };

    const setVideoMeta = (v) => {
      d('#videoMeta').classList.remove('d-none');
      d('#playlistMeta').classList.add('d-none');
      d('#thumb').src = v.thumbnail || '';
      d('#title').textContent = v.title || '';
      d('#channel').textContent = v.channel ? `By ${v.channel}` : '';
      d('#duration').textContent = v.duration ? `‚Ä¢ ${secondsToHms(v.duration)}` : '';
      const resSel = d('#resolution');
      resSel.innerHTML = '';
      const optimizedRes = getOptimizedResolutions(v.resolutions);
      (optimizedRes.length > 0 ? optimizedRes : ['1080p', '720p', '480p', '360p']).forEach(r => {
        const opt = document.createElement('option');
        opt.value = r; opt.textContent = r; resSel.appendChild(opt);
      });
    }

    const setPlaylistMeta = (pl) => {
      d('#videoMeta').classList.add('d-none');
      d('#playlistMeta').classList.remove('d-none');
      const list = d('#playlistList');
      list.innerHTML = '';
      const commonRes = new Set();
      (pl.entries || []).forEach((e, idx) => {
        (e.resolutions || []).forEach(r => commonRes.add(r));
        const col = document.createElement('div');
        col.className = 'col';
        col.innerHTML = `
      <div class="card h-100">
        <img src="${e.thumbnail || ''}" class="card-img-top" alt="thumb">
        <div class="card-body">
          <h6 class="card-title">${e.title || ''}</h6>
          <div class="form-check">
            <input class="form-check-input sel" type="checkbox" value="${idx + 1}" id="v_${idx}">
            <label class="form-check-label" for="v_${idx}">Select</label>
          </div>
        </div>
      </div>`;
        list.appendChild(col);
      });
      const resSel = d('#plResolution');
      resSel.innerHTML = '';
      const allResolutions = Array.from(commonRes);
      const optimizedRes = getOptimizedResolutions(allResolutions);
      const sortedRes = (optimizedRes.length > 0 ? optimizedRes : allResolutions.filter(r => parseInt(r) >= 144))
        .sort((a, b) => parseInt(b) - parseInt(a)); // Sort descending (highest quality first)
      (sortedRes.length > 0 ? sortedRes : ['1080p', '720p', '480p', '360p']).forEach(r => {
        const opt = document.createElement('option'); opt.value = r; opt.textContent = r; resSel.appendChild(opt);
      });
      d('#selectAll').checked = false;
    }

    let lastMeta = null;

    d('#fetchBtn').addEventListener('click', async () => {
      const url = d('#url').value.trim();
      if (!url) { alert('Enter a URL'); return; }
      // loading state
      const btn = d('#fetchBtn');
      btn.disabled = true; btn.querySelector('.fetch-text').classList.add('d-none'); btn.querySelector('.spinner-border').classList.remove('d-none');
      const res = await fetch('/api/metadata', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url }) });
      const data = await res.json();
      btn.disabled = false; btn.querySelector('.fetch-text').classList.remove('d-none'); btn.querySelector('.spinner-border').classList.add('d-none');
      if (data.error) { alert(data.error); return; }
      lastMeta = data;
      d('#metaSection').classList.remove('d-none');
      if (data.type === 'video') setVideoMeta(data.video);
      else setPlaylistMeta(data);
    });

    // Playlist select all
    d('#selectAll').addEventListener('change', (e) => {
      dd('.sel').forEach(cb => cb.checked = e.target.checked);
    });

    // Start single video download
    d('#downloadBtn').addEventListener('click', async () => {
      const url = d('#url').value.trim();
      const kind = d('#format').value;
      const resolution = d('#resolution').value;
      await startDownload({ url, kind, resolution });
    });

    // Start playlist download
    d('#plDownloadBtn').addEventListener('click', async () => {
      const url = d('#url').value.trim();
      const kind = d('#plFormat').value;
      const resolution = d('#plResolution').value;
      const selection_ids = Array.from(dd('.sel')).filter(cb => cb.checked).map(cb => parseInt(cb.value));
      if (selection_ids.length === 0) { alert('Select at least one video'); return; }

      // Show playlist progress counter
      d('#playlistProgress').classList.remove('d-none');
      d('#totalVideos').textContent = selection_ids.length;
      d('#currentVideo').textContent = '1';

      await startDownload({ url, kind, resolution, selection_ids });
    });

    async function startDownload(payload) {
      const res = await fetch('/api/download', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      const data = await res.json();
      if (data.error) { alert(data.error); return; }
      d('#progressArea').classList.remove('d-none');
      pollProgress(data.job_id);
    }

    async function pollProgress(jobId) {
      const bar = d('#progressBar');
      const file = d('#currentFile');
      const eta = d('#eta');
      const qrWrap = d('#qrWrap');
      const qr = d('#qr');
      const doneArea = d('#doneArea');
      const downloadLink = d('#downloadLink');
      const playlistProgress = d('#playlistProgress');
      const currentVideo = d('#currentVideo');
      const itemsProgress = d('#itemsProgress');
      const doneHint = d('#doneHint');

      const iv = setInterval(async () => {
        const res = await fetch(`/api/progress/${jobId}`);
        const data = await res.json();
        if (data.error) { clearInterval(iv); alert(data.error); return; }

        const pct = Math.floor(data.progress || 0);  // Progress already in 0-100 range
        bar.style.width = pct + '%'; bar.textContent = pct + '%';
        file.textContent = data.filename || 'Working...';
        eta.textContent = data.eta ? `ETA ${data.eta}s` : '';

        // Render per-item progress if provided
        if (Array.isArray(data.items) && data.items.length > 0) {
          itemsProgress.classList.remove('d-none');
          itemsProgress.innerHTML = '';
          data.items.forEach(it => {
            const ipct = typeof it.progress === 'number' ? it.progress : 0;
            const row = document.createElement('div');
            row.className = 'mb-2';
            row.innerHTML = `
          <div class="d-flex justify-content-between small mb-1">
            <span>${it.title || `Item ${it.index}`}</span>
            <span>${Math.floor(ipct)}%</span>
          </div>
          <div class="progress" style="height: 8px;">
            <div class="progress-bar" style="width:${Math.floor(ipct)}%"></div>
          </div>`;
            itemsProgress.appendChild(row);
          });
        }

        // Update playlist count text if available
        if (data.total_videos) {
          playlistProgress.classList.remove('d-none');
          d('#totalVideos').textContent = data.total_videos;
          // current_video is approximated by number of items with status completed/processing
          const doneCount = (data.items || []).filter(it => it.status === 'processing' || it.progress === 100).length;
          currentVideo.textContent = Math.min(doneCount + 1, data.total_videos);
        }

        if (data.status === 'completed') {
          clearInterval(iv);
          bar.classList.add('bg-success');

          // ‚ú® Show notification when download completes
          showDownloadNotification(data.filename || 'Your video');

          if (data.download_url) {
            doneArea.classList.remove('d-none');
            downloadLink.href = data.download_url;
            if (String(data.filename || '').endsWith('.zip')) {
              downloadLink.textContent = 'Download ZIP';
              doneHint.textContent = 'Extract after download to get all videos.';
            } else {
              downloadLink.textContent = 'Download file';
              doneHint.textContent = '';
            }
          }
          if (data.qr) {
            qrWrap.classList.remove('d-none');
            qr.src = data.qr;
          }
        }
        if (data.status === 'error') {
          clearInterval(iv);
          bar.classList.add('bg-danger');
          alert(data.error || 'Error');
        }
      }, 1000);
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>